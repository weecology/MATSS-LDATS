#' @name run_LDA
#' @title Run Latent Dirichlet Allocation on Tabular Data
#' @description Test the Latent Dirichlet Allocation (LDA) model on the data
#'   with different number of topics (from 2 to `max_topics`), select the best
#'   one using AIC, and return the model object that is selected.
#'
#' @param data a data.frame or tibble; each row is an observation (e.g. in
#'   time or space), and each column is a variable. Here, the common usage is
#'   for each column to be a species or taxon, and each row to be an observed
#'   sample. In the original specification for LDA, each row is a document,
#'   and each column is a word, with the entries being the counts of the words
#'   in each document.
#' @param max_topics the maximum number of topics to try (the function will
#'   test a number of topics from 2 to `max_topics`)
#' @inheritParams LDATS::LDA_set
#'
#' @return list of `lda = [the set of LDA models]` from running LDATS::parLDA(), `data = data)`
#' @export
#' @importFrom dplyr filter mutate group_by ungroup
#' 
run_LDA <- function(data,
                    max_topics = 6, nseeds = 200,
                    control = list())
{
    if (!MATSS::check_data_format(data))
    {
        wrongFormat = simpleWarning("Incorrect data structure, see data-formats vignette")
        tryCatch(warning(wrongFormat), finally = return('Incorrect data structure'))
    }

    #### Run LDAs ####
    abundances <- data$abundance
    topics_vector <- seq(from = 2, to = max_topics, by = 1)
    LDA_models <- LDATS::LDA_set(document_term_table = abundances,
                                topics = topics_vector,
                                nseeds = nseeds, control = control)
    
    model_info <- make_lda_table(names(LDA_models)) %>%
        dplyr::mutate(LDA_AICc = vapply(LDA_models, FUN = LDATS::AICc, FUN.VAL = 100)) %>%
        dplyr::group_by(k) %>%
        dplyr::mutate(is_best_seed = (LDA_AICc == min(LDA_AICc))) %>%
        dplyr::ungroup()
    
    LDA_models <- LDA_models[ which(model_info$is_best_seed)]
    
    class(LDA_models) <- "LDA_set"
    
    model_info <- dplyr::filter(model_info, is_best_seed) %>%
        dplyr::mutate(lda_model_index = 1:sum(is_best_seed))
    
    return(list(lda = LDA_models,
                data = data,
                model_info = model_info))

}

#' LDA select
#'
#' @param lda_list list of LDA + data
#'
#' @return list of selected LDA + data
#' @export
#' @importFrom LDATS select_LDA AICc
# select_LDA_list <- function(lda_list) {
#     lda = lda_list$lda
#     lda_select <- LDATS::select_LDA(lda, control = list(measurer = LDATS::AICc))
#     
#     return(list(lda = lda_select, 
#                 upstream = list(data = data)))
# }
