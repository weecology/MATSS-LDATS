Toy full likelihood
================
Renata Diaz
8/6/2019

Full model likelihood
---------------------

Based on Slack & in person conversation with Hao Ye & Juniper Simonis.

Tacking a full likelihood computation on to existing runs of LDA\_TS models, moving towards whole-model evaluation of goodness of fit (instead of evaluting and selecting LDA and TS components separately and sequentially).

Likelihood of observed dataset (observed term frequencies in each document) from LDA and TS model...

``` r
dat1 <- readd(bbs_data_rtrg_1_11, cache = cache)
counts1 <- dat1$abundance
lda1 <- readd(lda_select_lda_bbs_data_rtrg_1_11_5, cache = cache)
ts1 <- readd(ts_select_ts_bbs_data_rtrg_1_11_lda_select_lda_bbs_data_rtrg_1_11_5, cache = cache)

plot(lda1)
```

![](full_likelihood_files/figure-markdown_github/pull%20in%20an%20LDA%20and%20a%20TS%20model-1.png)

``` r
plot(ts1)
```

![](full_likelihood_files/figure-markdown_github/pull%20in%20an%20LDA%20and%20a%20TS%20model-2.png)

``` r
beta1 <- lda1$`k: 5, seed: 122`@beta

beta1exp <- exp(beta1)

get_thetas <- function(x) {
    rhos <- x$rhos
    nrhos <- ncol(rhos)
    if (!is.null(nrhos)){
        if (selection == "median"){
            spec_rhos <- apply(rhos, 2, median)
        } else if (selection == "mode"){
            spec_rhos <- apply(rhos, 2, modalvalue)
        } else {
            stop("selection input not supported")
        }
    } else{
        spec_rhos <- NULL
    }
    seg_mods <- multinom_TS(x$data, x$formula, spec_rhos,  
                            x$timename, x$weights, x$control)
    
    time_obs <- rep(NA, nrow(x$data))
    ntopics <- ncol(as.matrix(x$data[[x$control$response]]))
    nsegs <- length(seg_mods[[1]])
    pred_vals <- matrix(NA, nrow(x$data), ntopics)
    sp1 <- 1
    for (i in 1:nsegs){
        mod_i <- seg_mods[[1]][[i]]
        spec_vals <- sp1:(sp1 + nrow(mod_i$fitted.values) - 1)
        pred_vals[spec_vals, ] <- mod_i$fitted.values
        time_obs[spec_vals] <- mod_i$timevals
        sp1 <- sp1 + nrow(mod_i$fitted.values)
    }
    
    return(pred_vals) 
}

theta1 <- get_thetas(ts1)

P1 <- theta1 %*% beta1

P1exp <- theta1 %*% beta1exp

head(P1exp)
```

    ##              [,1]         [,2]         [,3]         [,4]       [,5]
    ## [1,] 7.218425e-07 0.0007256760 9.601615e-05 0.0001432925 0.03186681
    ## [2,] 8.940265e-07 0.0007332170 9.326091e-05 0.0001491226 0.03149495
    ## [3,] 1.106148e-06 0.0007404945 9.050614e-05 0.0001550386 0.03111944
    ## [4,] 1.367170e-06 0.0007474784 8.775646e-05 0.0001610289 0.03074082
    ## [5,] 1.687992e-06 0.0007541377 8.501668e-05 0.0001670806 0.03035969
    ## [6,] 2.081846e-06 0.0007604407 8.229172e-05 0.0001731796 0.02997670
    ##              [,6]        [,7]       [,8]         [,9]        [,10]
    ## [1,] 1.686604e-05 0.005500146 0.05898849 5.852140e-08 0.0005888523
    ## [2,] 1.812719e-05 0.005524513 0.05932471 7.248183e-08 0.0005952395
    ## [3,] 1.947301e-05 0.005548974 0.05964589 8.968038e-08 0.0006017395
    ## [4,] 2.090965e-05 0.005573472 0.05995068 1.108439e-07 0.0006083433
    ## [5,] 2.244409e-05 0.005597951 0.06023774 1.368560e-07 0.0006150408
    ## [6,] 2.408432e-05 0.005622352 0.06050571 1.687895e-07 0.0006218211
    ##             [,11]        [,12]        [,13]        [,14]        [,15]
    ## [1,] 2.008565e-08 0.0004427638 0.0005179145 5.185271e-05 1.950706e-08
    ## [2,] 2.477968e-08 0.0004468874 0.0005355157 5.345041e-05 2.416053e-08
    ## [3,] 3.055516e-08 0.0004513582 0.0005532515 5.505269e-05 2.989338e-08
    ## [4,] 3.765437e-08 0.0004562053 0.0005710833 5.665578e-05 3.694787e-08
    ## [5,] 4.637186e-08 0.0004614617 0.0005889698 5.825564e-05 4.561856e-08
    ## [6,] 5.706522e-08 0.0004671643 0.0006068671 5.984803e-05 5.626306e-08
    ##             [,16]        [,17]        [,18]        [,19]        [,20]
    ## [1,] 7.265227e-06 1.716276e-05 0.0008218395 0.0001352868 0.0007690827
    ## [2,] 7.564996e-06 1.787811e-05 0.0008214784 0.0001319623 0.0007754420
    ## [3,] 7.869139e-06 1.860467e-05 0.0008210657 0.0001286226 0.0007814327
    ## [4,] 8.177046e-06 1.934117e-05 0.0008205983 0.0001252719 0.0007870245
    ## [5,] 8.488050e-06 2.008623e-05 0.0008200730 0.0001219142 0.0007921866
    ## [6,] 8.801427e-06 2.083835e-05 0.0008194866 0.0001185538 0.0007968881
    ##             [,21]        [,22]        [,23]       [,24]        [,25]
    ## [1,] 1.010686e-04 0.0003164329 1.950914e-08 0.004477038 1.950706e-08
    ## [2,] 9.997369e-05 0.0003184218 2.416276e-08 0.004404158 2.416053e-08
    ## [3,] 9.884833e-05 0.0003202095 2.989575e-08 0.004330310 2.989338e-08
    ## [4,] 9.769403e-05 0.0003217872 3.695040e-08 0.004255555 3.694787e-08
    ## [5,] 9.651269e-05 0.0003231473 4.562126e-08 0.004179955 4.561856e-08
    ## [6,] 9.530663e-05 0.0003242837 5.626594e-08 0.004103570 5.626306e-08
    ##            [,26]       [,27]       [,28]       [,29]        [,30]
    ## [1,] 0.005490289 0.001426532 0.009962575 0.008302246 1.077518e-04
    ## [2,] 0.005420645 0.001454353 0.009974147 0.008310838 1.054556e-04
    ## [3,] 0.005350017 0.001481540 0.009984973 0.008317036 1.031500e-04
    ## [4,] 0.005278456 0.001508021 0.009994980 0.008320665 1.008394e-04
    ## [5,] 0.005206013 0.001533721 0.010004086 0.008321544 9.852891e-05
    ## [6,] 0.005132737 0.001558566 0.010012204 0.008319487 9.622382e-05
    ##             [,31]        [,32]        [,33]        [,34]       [,35]
    ## [1,] 0.0001792204 1.811647e-05 0.0002071853 1.108185e-05 0.001043344
    ## [2,] 0.0001763657 1.760959e-05 0.0002007489 1.115497e-05 0.001059025
    ## [3,] 0.0001735184 1.711104e-05 0.0001943150 1.123166e-05 0.001074381
    ## [4,] 0.0001706837 1.662338e-05 0.0001878930 1.131168e-05 0.001089380
    ## [5,] 0.0001678671 1.614953e-05 0.0001814923 1.139474e-05 0.001103990
    ## [6,] 0.0001650741 1.569286e-05 0.0001751222 1.148051e-05 0.001118182
    ##             [,36]      [,37]        [,38]       [,39]       [,40]
    ## [1,] 0.0002091713 0.02184505 0.0009862296 0.003018832 0.007031024
    ## [2,] 0.0002108491 0.02245519 0.0010270909 0.002962403 0.007001866
    ## [3,] 0.0002126704 0.02307626 0.0010685473 0.002905787 0.006973749
    ## [4,] 0.0002146389 0.02370721 0.0011105158 0.002849062 0.006946721
    ## [5,] 0.0002167582 0.02434684 0.0011529054 0.002792306 0.006920820
    ## [6,] 0.0002190312 0.02499386 0.0011956177 0.002735599 0.006896070
    ##           [,41]       [,42]      [,43]      [,44]     [,45]     [,46]
    ## [1,] 0.04404394 0.008546662 0.05054355 0.06967234 0.1437391 0.1113136
    ## [2,] 0.04418084 0.008531670 0.05094398 0.07132141 0.1443312 0.1102587
    ## [3,] 0.04430694 0.008517800 0.05134213 0.07296724 0.1449814 0.1091899
    ## [4,] 0.04442137 0.008505138 0.05173706 0.07460786 0.1456922 0.1081074
    ## [5,] 0.04452322 0.008493765 0.05212781 0.07624146 0.1464660 0.1070113
    ## [6,] 0.04461156 0.008483758 0.05251336 0.07786633 0.1473052 0.1059018
    ##            [,47]       [,48]       [,49]     [,50]        [,51]
    ## [1,] 0.001217378 0.002927604 0.003995834 0.1512687 0.0001038990
    ## [2,] 0.001242896 0.002952603 0.004174034 0.1490661 0.0001113136
    ## [3,] 0.001268284 0.002976511 0.004357525 0.1468268 0.0001191408
    ## [4,] 0.001293529 0.002999246 0.004546216 0.1445530 0.0001273925
    ## [5,] 0.001318627 0.003020726 0.004739991 0.1422476 0.0001360800
    ## [6,] 0.001343584 0.003040875 0.004938700 0.1399133 0.0001452138
    ##            [,52]       [,53]        [,54]      [,55]       [,56]
    ## [1,] 0.005404753 0.002880417 2.175736e-05 0.01588103 0.007182817
    ## [2,] 0.005420517 0.002996000 2.265894e-05 0.01626923 0.007170190
    ## [3,] 0.005437342 0.003113290 2.357366e-05 0.01666057 0.007160766
    ## [4,] 0.005455308 0.003232052 2.449967e-05 0.01705439 0.007154647
    ## [5,] 0.005474502 0.003352027 2.543497e-05 0.01744997 0.007151925
    ## [6,] 0.005495015 0.003472936 2.637738e-05 0.01784653 0.007152681
    ##             [,57]       [,58]        [,59]        [,60]        [,61]
    ## [1,] 0.0006636040 0.004072466 5.208362e-05 7.799687e-06 0.0008141161
    ## [2,] 0.0006907363 0.004102384 5.045306e-05 8.157223e-06 0.0008277232
    ## [3,] 0.0007182663 0.004131681 4.882335e-05 8.529018e-06 0.0008420487
    ## [4,] 0.0007461384 0.004160231 4.719692e-05 8.916599e-06 0.0008571411
    ## [5,] 0.0007742923 0.004187895 4.557614e-05 9.321899e-06 0.0008730574
    ## [6,] 0.0008026625 0.004214530 4.396337e-05 9.747357e-06 0.0008898648
    ##            [,62]        [,63]        [,64]       [,65]        [,66]
    ## [1,] 0.002328228 9.428233e-05 1.881079e-05 0.006010130 0.0004428374
    ## [2,] 0.002409029 9.818916e-05 2.016884e-05 0.005935147 0.0004436452
    ## [3,] 0.002491466 1.021529e-04 2.160640e-05 0.005860518 0.0004443181
    ## [4,] 0.002575415 1.061656e-04 2.312678e-05 0.005786515 0.0004448491
    ## [5,] 0.002660744 1.102185e-04 2.473340e-05 0.005713443 0.0004452317
    ## [6,] 0.002747308 1.143023e-04 2.642990e-05 0.005641648 0.0004454599
    ##             [,67]        [,68]        [,69]       [,70]        [,71]
    ## [1,] 7.252454e-06 9.758218e-08 7.783638e-05 0.001006133 3.358370e-05
    ## [2,] 7.552982e-06 1.208528e-07 7.644576e-05 0.001018270 3.452992e-05
    ## [3,] 7.857886e-06 1.495205e-07 7.510945e-05 0.001029987 3.547723e-05
    ## [4,] 8.166555e-06 1.847966e-07 7.383522e-05 0.001041246 3.642457e-05
    ## [5,] 8.478322e-06 2.281538e-07 7.263155e-05 0.001052006 3.737103e-05
    ## [6,] 8.792461e-06 2.813803e-07 7.150775e-05 0.001062226 3.831598e-05
    ##           [,72]       [,73]       [,74]       [,75]      [,76]
    ## [1,] 0.02387261 0.008609773 0.002034318 0.008498446 0.02972834
    ## [2,] 0.02344976 0.008528434 0.002020215 0.008697662 0.02969922
    ## [3,] 0.02302545 0.008448757 0.002005889 0.008904370 0.02966251
    ## [4,] 0.02260027 0.008370801 0.001991366 0.009118481 0.02961792
    ## [5,] 0.02217483 0.008294604 0.001976676 0.009339881 0.02956518
    ## [6,] 0.02174974 0.008220179 0.001961851 0.009568433 0.02950402
    ##             [,77]       [,78]        [,79]        [,80]        [,81]
    ## [1,] 9.037149e-05 0.001653530 0.0009274190 3.207348e-05 0.0002083341
    ## [2,] 9.450523e-05 0.001688606 0.0009177642 3.360139e-05 0.0002018118
    ## [3,] 9.899113e-05 0.001724929 0.0009078252 3.520386e-05 0.0001952931
    ## [4,] 1.038740e-04 0.001762510 0.0008976017 3.689082e-05 0.0001887873
    ## [5,] 1.092070e-04 0.001801356 0.0008870935 3.867462e-05 0.0001823043
    ## [6,] 1.150534e-04 0.001841474 0.0008763003 4.057067e-05 0.0001758532
    ##             [,82]       [,83]       [,84]        [,85]      [,86]
    ## [1,] 5.758413e-05 0.002089723 0.001513029 8.021330e-06 0.02742962
    ## [2,] 5.850607e-05 0.002088245 0.001487812 8.276197e-06 0.02721329
    ## [3,] 5.938461e-05 0.002086938 0.001463605 8.535280e-06 0.02699653
    ## [4,] 6.021637e-05 0.002085838 0.001440555 8.798041e-06 0.02677975
    ## [5,] 6.099803e-05 0.002084988 0.001418823 9.063888e-06 0.02656335
    ## [6,] 6.172632e-05 0.002084432 0.001398587 9.332175e-06 0.02634777
    ##             [,87]      [,88]       [,89]        [,90]       [,91]
    ## [1,] 3.901413e-08 0.05487061 0.001116572 0.0005599724 0.004358089
    ## [2,] 4.832107e-08 0.05419971 0.001162840 0.0005525049 0.004316026
    ## [3,] 5.978676e-08 0.05352393 0.001209782 0.0005452704 0.004273159
    ## [4,] 7.389574e-08 0.05284382 0.001257303 0.0005382953 0.004229509
    ## [5,] 9.123712e-08 0.05215990 0.001305302 0.0005316065 0.004185098
    ## [6,] 1.125261e-07 0.05147267 0.001353666 0.0005252309 0.004139947
    ##             [,92]       [,93]        [,94]       [,95]        [,96]
    ## [1,] 1.450490e-05 0.007252718 0.0008049715 0.002955612 6.523213e-05
    ## [2,] 1.510596e-05 0.007412628 0.0008119740 0.003089582 6.445773e-05
    ## [3,] 1.571577e-05 0.007573848 0.0008198513 0.003232280 6.370677e-05
    ## [4,] 1.633311e-05 0.007736206 0.0008286575 0.003384142 6.298143e-05
    ## [5,] 1.695664e-05 0.007899520 0.0008384499 0.003545637 6.228389e-05
    ## [6,] 1.758492e-05 0.008063602 0.0008492892 0.003717271 6.161629e-05
    ##             [,97]      [,98]        [,99]
    ## [1,] 0.0001592429 0.02124796 4.527063e-05
    ## [2,] 0.0001616559 0.02132873 4.638473e-05
    ## [3,] 0.0001639560 0.02140577 4.749437e-05
    ## [4,] 0.0001661377 0.02147891 4.859752e-05
    ## [5,] 0.0001681963 0.02154802 4.969213e-05
    ## [6,] 0.0001701282 0.02161302 5.077605e-05

``` r
rowSums(P1exp)
```

    ##  [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
    ## [36] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1

``` r
get_doc_lik <- function(index, counts_matrix, p_matrix) {
    counts <- as.integer(counts_matrix[index, ])
    ps <- p_matrix[index, ]
    doc_loglik <- dmultinom(x = counts, prob = ps, log = TRUE)
    return(doc_loglik)
}

doc_lik1 <- vapply(1:nrow(counts1), FUN = get_doc_lik, counts_matrix = counts1, 
                   p_matrix = P1exp, FUN.VALUE = -1)

sum(doc_lik1)
```

    ## [1] -18622

``` r
ldapars <- attr(logLik(lda1[[1]]), "df")
tspars <- attr(logLik(ts1), "df")

totalpars <- ldapars + tspars

nobs <- attr(logLik(ts1), "nobs")

AICc <- (-2 * (sum(doc_lik1))) + 2*(totalpars) + 
    (2 * totalpars^2 + 2 * totalpars)/(nobs - totalpars - 1)

AICc
```

    ## [1] 37130.76
