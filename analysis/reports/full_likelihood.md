Toy full likelihood
================
Renata Diaz
8/6/2019

Full model likelihood
---------------------

Based on Slack & in person conversation with Hao Ye & Juniper Simonis.

Tacking a full likelihood computation on to existing runs of LDA\_TS models, moving towards whole-model evaluation of goodness of fit (instead of evaluting and selecting LDA and TS components separately and sequentially).

Likelihood of observed dataset (observed term frequencies in each document) from LDA and TS model...

``` r
lda1 <- readd(lda_select_lda_bbs_data_rtrg_1_11_5, cache = cache)
ts1 <- readd(ts_select_ts_bbs_data_rtrg_1_11_lda_select_lda_bbs_data_rtrg_1_11_5, cache = cache)

plot(lda1)
```

![](full_likelihood_files/figure-markdown_github/pull%20in%20an%20LDA%20and%20a%20TS%20model-1.png)

``` r
plot(ts1)
```

![](full_likelihood_files/figure-markdown_github/pull%20in%20an%20LDA%20and%20a%20TS%20model-2.png)

``` r
beta1 <- lda1$`k: 5, seed: 122`@beta

get_thetas <- function(x) {
    rhos <- x$rhos
    nrhos <- ncol(rhos)
    if (!is.null(nrhos)){
        if (selection == "median"){
            spec_rhos <- apply(rhos, 2, median)
        } else if (selection == "mode"){
            spec_rhos <- apply(rhos, 2, modalvalue)
        } else {
            stop("selection input not supported")
        }
    } else{
        spec_rhos <- NULL
    }
    seg_mods <- multinom_TS(x$data, x$formula, spec_rhos,  
                            x$timename, x$weights, x$control)
    
    time_obs <- rep(NA, nrow(x$data))
    ntopics <- ncol(as.matrix(x$data[[x$control$response]]))
    nsegs <- length(seg_mods[[1]])
    pred_vals <- matrix(NA, nrow(x$data), ntopics)
    sp1 <- 1
    for (i in 1:nsegs){
        mod_i <- seg_mods[[1]][[i]]
        spec_vals <- sp1:(sp1 + nrow(mod_i$fitted.values) - 1)
        pred_vals[spec_vals, ] <- mod_i$fitted.values
        time_obs[spec_vals] <- mod_i$timevals
        sp1 <- sp1 + nrow(mod_i$fitted.values)
    }
    
    return(pred_vals) 
}

theta1 <- get_thetas(ts1)

P1 <- theta1 %*% beta1

head(P1)
```

    ##           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
    ## [1,] -54.02170 -8.134566 -12.63527 -20.10527 -3.538200 -28.07882 -5.252097
    ## [2,] -53.77077 -8.175293 -12.80289 -20.20788 -3.552682 -28.07342 -5.249600
    ## [3,] -53.50839 -8.219414 -12.97421 -20.30432 -3.567433 -28.06111 -5.247137
    ## [4,] -53.23426 -8.267090 -13.14905 -20.39421 -3.582440 -28.04147 -5.244717
    ## [5,] -52.94806 -8.318484 -13.32720 -20.47716 -3.597687 -28.01409 -5.242347
    ## [6,] -52.64944 -8.373761 -13.50843 -20.55282 -3.613156 -27.97852 -5.240036
    ##           [,8]      [,9]     [,10]     [,11]     [,12]     [,13]     [,14]
    ## [1,] -2.903428 -52.81818 -7.514514 -131.0761 -8.050344 -9.674742 -12.61066
    ## [2,] -2.897679 -52.85023 -7.505314 -131.7772 -8.057599 -9.662639 -12.65800
    ## [3,] -2.892194 -52.87536 -7.495964 -132.4473 -8.064697 -9.652648 -12.71152
    ## [4,] -2.886997 -52.89290 -7.486477 -133.0830 -8.071590 -9.644911 -12.77163
    ## [5,] -2.882115 -52.90213 -7.476866 -133.6804 -8.078227 -9.639563 -12.83877
    ## [6,] -2.877570 -52.90226 -7.467147 -134.2356 -8.084553 -9.636735 -12.91343
    ##          [,15]     [,16]     [,17]     [,18]     [,19]     [,20]     [,21]
    ## [1,] -155.3492 -42.53135 -27.67169 -7.105749 -12.33735 -8.270987 -12.44112
    ## [2,] -153.6319 -43.57722 -27.59977 -7.106300 -12.55423 -8.327589 -12.60048
    ## [3,] -151.9217 -44.66265 -27.51989 -7.106921 -12.77995 -8.388724 -12.76375
    ## [4,] -150.2203 -45.78919 -27.43181 -7.107615 -13.01462 -8.454648 -12.93075
    ## [5,] -148.5287 -46.95859 -27.33531 -7.108387 -13.25832 -8.525636 -13.10125
    ## [6,] -146.8483 -48.17274 -27.23018 -7.109240 -13.51109 -8.601986 -13.27498
    ##          [,22]     [,23]     [,24]     [,25]     [,26]     [,27]     [,28]
    ## [1,] -9.397381 -134.6939 -5.693948 -155.7236 -5.322822 -7.915109 -4.613402
    ## [2,] -9.455271 -135.3950 -5.721653 -154.0338 -5.339614 -7.860299 -4.612281
    ## [3,] -9.516871 -136.0658 -5.750073 -152.3509 -5.356800 -7.805845 -4.611241
    ## [4,] -9.582254 -136.7026 -5.779206 -150.6761 -5.374378 -7.751853 -4.610290
    ## [5,] -9.651482 -137.3016 -5.809046 -149.0109 -5.392344 -7.698427 -4.609440
    ## [6,] -9.724600 -137.8590 -5.839592 -147.3561 -5.410697 -7.645673 -4.608700
    ##          [,29]     [,30]     [,31]     [,32]     [,33]     [,34]     [,35]
    ## [1,] -4.905931 -11.12505 -9.716488 -32.60037 -12.42977 -105.1518 -7.249679
    ## [2,] -4.911829 -11.23561 -9.772076 -32.97078 -12.61907 -107.1817 -7.227311
    ## [3,] -4.918416 -11.34891 -9.828183 -33.32602 -12.81357 -109.1934 -7.205180
    ## [4,] -4.925729 -11.46486 -9.884699 -33.66488 -13.01322 -111.1845 -7.183325
    ## [5,] -4.933809 -11.58333 -9.941501 -33.98615 -13.21801 -113.1528 -7.161785
    ## [6,] -4.942699 -11.70416 -9.998462 -34.28867 -13.42787 -115.0964 -7.140598
    ##          [,36]     [,37]     [,38]     [,39]     [,40]     [,41]     [,42]
    ## [1,] -8.613984 -4.524236 -24.18863 -6.155962 -5.011516 -3.168361 -4.787586
    ## [2,] -8.611703 -4.507744 -24.30300 -6.183212 -5.016381 -3.166047 -4.790349
    ## [3,] -8.608921 -4.490826 -24.41016 -6.210683 -5.021172 -3.164033 -4.793018
    ## [4,] -8.605620 -4.473501 -24.50969 -6.238334 -5.025904 -3.162345 -4.795581
    ## [5,] -8.601783 -4.455792 -24.60119 -6.266125 -5.030598 -3.161010 -4.798029
    ## [6,] -8.597395 -4.437721 -24.68428 -6.294014 -5.035282 -3.160057 -4.800353
    ##          [,43]     [,44]     [,45]     [,46]     [,47]     [,48]     [,49]
    ## [1,] -3.030006 -3.896799 -1.994886 -2.326848 -7.574842 -6.026181 -7.577235
    ## [2,] -3.021701 -3.842081 -1.994095 -2.342754 -7.533597 -6.016406 -7.501767
    ## [3,] -3.013444 -3.787426 -1.993059 -2.359177 -7.492469 -6.006967 -7.425994
    ## [4,] -3.005256 -3.732910 -1.991760 -2.376135 -7.451515 -5.997892 -7.350075
    ## [5,] -2.997156 -3.678608 -1.990186 -2.393646 -7.410786 -5.989209 -7.274183
    ## [6,] -2.989166 -3.624594 -1.988321 -2.411732 -7.370333 -5.980944 -7.198514
    ##          [,50]     [,51]     [,52]     [,53]     [,54]     [,55]     [,56]
    ## [1,] -2.339081 -39.28811 -5.361339 -18.45222 -32.96171 -4.583010 -6.054479
    ## [2,] -2.372805 -38.74040 -5.364881 -18.64021 -32.84821 -4.554256 -6.073389
    ## [3,] -2.407326 -38.19122 -5.368398 -18.82586 -32.73249 -4.525423 -6.091044
    ## [4,] -2.442613 -37.64113 -5.371868 -19.00901 -32.61484 -4.496563 -6.107365
    ## [5,] -2.478624 -37.09065 -5.375268 -19.18956 -32.49559 -4.467730 -6.122277
    ## [6,] -2.515317 -36.54027 -5.378575 -19.36744 -32.37511 -4.438984 -6.135705
    ##          [,57]     [,58]     [,59]     [,60]     [,61]     [,62]     [,63]
    ## [1,] -22.35830 -5.772685 -56.33010 -33.96580 -7.258204 -11.97901 -36.26058
    ## [2,] -22.57989 -5.780391 -58.37654 -34.13706 -7.247484 -12.02860 -36.45977
    ## [3,] -22.79844 -5.789071 -60.47773 -34.29463 -7.236285 -12.07346 -36.64482
    ## [4,] -23.01364 -5.798786 -62.63236 -34.43767 -7.224595 -12.11333 -36.81495
    ## [5,] -23.22518 -5.809605 -64.83886 -34.56535 -7.212399 -12.14794 -36.96943
    ## [6,] -23.43278 -5.821597 -67.09540 -34.67685 -7.199679 -12.17703 -37.10758
    ##          [,64]     [,65]     [,66]     [,67]     [,68]     [,69]     [,70]
    ## [1,] -35.40663 -5.321292 -7.839887 -35.79170 -60.02274 -15.35915 -7.211514
    ## [2,] -35.11889 -5.339782 -7.843923 -35.65112 -59.91817 -15.46817 -7.195284
    ## [3,] -34.82818 -5.358371 -7.848569 -35.50875 -59.80498 -15.57239 -7.179463
    ## [4,] -34.53460 -5.377015 -7.853848 -35.36494 -59.68256 -15.67143 -7.164104
    ## [5,] -34.23822 -5.395667 -7.859782 -35.22009 -59.55026 -15.76487 -7.149267
    ## [6,] -33.93908 -5.414275 -7.866389 -35.07463 -59.40736 -15.85231 -7.135014
    ##          [,71]     [,72]     [,73]     [,74]     [,75]     [,76]     [,77]
    ## [1,] -19.32194 -4.637540 -11.71542 -6.282926 -6.894363 -3.557276 -10.94401
    ## [2,] -19.06026 -4.687306 -11.89044 -6.292980 -6.908288 -3.559911 -10.96990
    ## [3,] -18.80012 -4.737627 -12.06543 -6.303201 -6.920059 -3.562858 -10.99579
    ## [4,] -18.54200 -4.788414 -12.24025 -6.313573 -6.929569 -3.566127 -11.02156
    ## [5,] -18.28632 -4.839575 -12.41484 -6.324076 -6.936711 -3.569729 -11.04707
    ## [6,] -18.03354 -4.891009 -12.58911 -6.334688 -6.941381 -3.573670 -11.07218
    ##          [,78]     [,79]     [,80]     [,81]     [,82]     [,83]     [,84]
    ## [1,] -6.599629 -7.956507 -23.34844 -15.87708 -16.77847 -6.261372 -8.557667
    ## [2,] -6.583890 -8.034317 -23.33296 -16.13432 -16.63697 -6.266049 -8.601277
    ## [3,] -6.567718 -8.116290 -23.31390 -16.39610 -16.49930 -6.270735 -8.642842
    ## [4,] -6.551116 -8.202580 -23.29114 -16.66254 -16.36585 -6.275412 -8.682192
    ## [5,] -6.534087 -8.293343 -23.26454 -16.93384 -16.23702 -6.280057 -8.719155
    ## [6,] -6.516633 -8.388743 -23.23396 -17.21029 -16.11317 -6.284646 -8.753561
    ##          [,85]     [,86]     [,87]     [,88]     [,89]     [,90]     [,91]
    ## [1,] -106.4364 -3.683601 -68.98347 -3.017205 -25.34703 -8.007974 -5.508547
    ## [2,] -108.4576 -3.694034 -69.80771 -3.032302 -25.45284 -8.033344 -5.520906
    ## [3,] -110.4606 -3.704525 -70.64073 -3.047664 -25.55294 -8.058377 -5.533576
    ## [4,] -112.4431 -3.715053 -71.48047 -3.063290 -25.64701 -8.083002 -5.546556
    ## [5,] -114.4030 -3.725597 -72.32464 -3.079179 -25.73472 -8.107144 -5.559843
    ## [6,] -116.3382 -3.736135 -73.17076 -3.095331 -25.81576 -8.130724 -5.573438
    ##          [,92]     [,93]     [,94]     [,95]     [,96]     [,97]     [,98]
    ## [1,] -38.77039 -5.331531 -7.870366 -6.939875 -10.35473 -13.30304 -3.903787
    ## [2,] -38.36777 -5.303166 -7.895560 -6.942085 -10.37392 -13.23440 -3.900190
    ## [3,] -37.96098 -5.274733 -7.920579 -6.943488 -10.39221 -13.16713 -3.896760
    ## [4,] -37.55058 -5.246272 -7.945335 -6.944011 -10.40953 -13.10134 -3.893503
    ## [5,] -37.13719 -5.217821 -7.969735 -6.943574 -10.42583 -13.03711 -3.890427
    ## [6,] -36.72144 -5.189421 -7.993679 -6.942095 -10.44102 -12.97451 -3.887536
    ##          [,99]
    ## [1,] -13.86154
    ## [2,] -13.72938
    ## [3,] -13.59855
    ## [4,] -13.46954
    ## [5,] -13.34287
    ## [6,] -13.21917
